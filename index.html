// React Template: Item Randomizer with Login/Register and Google Sheets Backend + Admin Page

import React, { useState } from 'react';
import { Card, CardContent } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';

const BACKEND_URL = https://script.google.com/macros/s/AKfycbxW4QBd-my9BwSUiU853nu_0nIPbCQN7F1cQ0GiB1lCMrLFm6sfbETcyYyiVVppEfenXg/exec;

export default function App() {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [characterName, setCharacterName] = useState('');
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [token, setToken] = useState(0);
  const [item, setItem] = useState(null);
  const [view, setView] = useState('login'); // 'login' | 'register' | 'dashboard' | 'admin'
  const [adminEmail, setAdminEmail] = useState('');
  const [adminTokens, setAdminTokens] = useState(0);

  const handleAuth = async (action) => {
    const params = new URLSearchParams({
      action,
      email,
      password,
    });
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      body: params,
    });
    const text = await res.text();
    if (text === 'LoginSuccess' || text === 'Registered') {
      setIsLoggedIn(true);
      setView(email === 'admin@example.com' ? 'admin' : 'dashboard');
      setToken(5); // Default for now
    } else {
      alert(text);
    }
  };

  const handleDraw = async () => {
    if (!characterName) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡πà‡∏°!');
    const url = `${BACKEND_URL}?email=${email}&character=${characterName}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data === 'NotEnoughTokens') {
      alert('Token ‡πÑ‡∏°‡πà‡∏û‡∏≠!');
    } else {
      setItem(data);
      setToken((prev) => prev - 1);
    }
  };

  const handleAdminAddToken = async () => {
    const params = new URLSearchParams({
      action: 'addtoken',
      email: adminEmail,
      token: adminTokens,
    });
    const res = await fetch(BACKEND_URL, {
      method: 'POST',
      body: params,
    });
    const text = await res.text();
    alert(text);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 to-gray-800 text-white flex items-center justify-center p-4">
      <Card className="w-full max-w-md">
        <CardContent className="space-y-4 p-6">
          {view === 'login' && (
            <>
              <h2 className="text-xl font-bold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
              <Input placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" value={email} onChange={(e) => setEmail(e.target.value)} />
              <Input placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
              <Button onClick={() => handleAuth('login')}>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</Button>
              <p className="text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <span onClick={() => setView('register')} className="text-blue-400 cursor-pointer">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></p>
            </>
          )}

          {view === 'register' && (
            <>
              <h2 className="text-xl font-bold">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
              <Input placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•" value={email} onChange={(e) => setEmail(e.target.value)} />
              <Input placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
              <Button onClick={() => handleAuth('register')}>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</Button>
              <p className="text-sm">‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <span onClick={() => setView('login')} className="text-blue-400 cursor-pointer">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></p>
            </>
          )}

          {view === 'dashboard' && (
            <>
              <h2 className="text-xl font-bold">üéÆ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö!</h2>
              <p>Token ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: <strong>{token}</strong></p>
              <Input placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" value={characterName} onChange={(e) => setCharacterName(e.target.value)} />
              <Button onClick={handleDraw}>‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° üîÆ</Button>
              {item && (
                <div className="mt-4 p-4 bg-gray-900 rounded-xl">
                  <p>üéÅ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: <strong>{item.item}</strong> ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ <strong>{item.character}</strong></p>
                </div>
              )}
              <Button variant="ghost" className="text-red-400" onClick={() => { setIsLoggedIn(false); setView('login'); }}>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</Button>
            </>
          )}

          {view === 'admin' && (
            <>
              <h2 className="text-xl font-bold">üõ†Ô∏è ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô - ‡πÄ‡∏ï‡∏¥‡∏° Token</h2>
              <Input placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" value={adminEmail} onChange={(e) => setAdminEmail(e.target.value)} />
              <Input placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Token ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°" type="number" value={adminTokens} onChange={(e) => setAdminTokens(Number(e.target.value))} />
              <Button onClick={handleAdminAddToken}>‡πÄ‡∏ï‡∏¥‡∏° Token</Button>
              <Button variant="ghost" className="text-red-400" onClick={() => { setIsLoggedIn(false); setView('login'); }}>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</Button>
            </>
          )}
        </CardContent>
      </Card>
    </div>
  );
}
