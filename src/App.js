import React, { useState, useEffect } from 'react';
import './App.css';

const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzib6C9lGk23Zemy9f0Vj78E5eK8-TQBIaZEGPE5l0FT2Kc0-vDbdfK5xsRG58qmseGsA/exec';
const ITEM_LIST = [
  '‡∏î‡∏≤‡∏ö‡πÄ‡∏ó‡∏û', '‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡πÄ‡∏´‡∏•‡πá‡∏Å', '‡∏´‡∏°‡∏ß‡∏Å‡∏ô‡∏±‡∏Å‡∏£‡∏ö', '‡∏õ‡∏µ‡∏Å‡∏õ‡∏µ‡∏®‡∏≤‡∏à',
  '‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á', '‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°', '‡πÇ‡∏•‡πà‡πÄ‡∏ß‡∏ó', '‡∏´‡∏≠‡∏Å‡∏™‡∏≤‡∏¢‡∏ü‡πâ‡∏≤',
  '‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡πÄ‡∏£‡πá‡∏ß', '‡πÅ‡∏´‡∏ß‡∏ô‡πÄ‡∏ß‡∏ó‡∏¢‡πå‡∏°‡∏ô‡∏ï‡∏£‡πå'
];

export default function App() {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [characterName, setCharacterName] = useState('');
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [token, setToken] = useState(0);
  const [item, setItem] = useState(null);
  const [view, setView] = useState('login');
  const [adminUser, setAdminUser] = useState('');
  const [adminTokens, setAdminTokens] = useState(0);
  const [isRolling, setIsRolling] = useState(false);
  const [history, setHistory] = useState([]);
  const [rate, setRate] = useState([
    { item: '‡∏î‡∏≤‡∏ö‡πÄ‡∏ó‡∏û', rate: '10%' },
    { item: '‡πÄ‡∏Å‡∏£‡∏≤‡∏∞‡πÄ‡∏´‡∏•‡πá‡∏Å', rate: '15%' },
    { item: '‡∏´‡∏°‡∏ß‡∏Å‡∏ô‡∏±‡∏Å‡∏£‡∏ö', rate: '20%' },
    { item: '‡∏õ‡∏µ‡∏Å‡∏õ‡∏µ‡∏®‡∏≤‡∏à', rate: '5%' },
    { item: '‡∏¢‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏•‡∏±‡∏á', rate: '30%' },
    { item: '‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏™‡∏∏‡πà‡∏°', rate: '10%' },
    { item: '‡πÇ‡∏•‡πà‡πÄ‡∏ß‡∏ó', rate: '5%' },
  ]);

  const fetchHistory = async () => {
    const url = `${BACKEND_URL}?action=gethistory`;
    const res = await fetch(url);
    const data = await res.json();
    const recentHistory = data.history ? data.history.slice(-20).reverse() : []; // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏Ñ‡πà 20 ‡πÅ‡∏ñ‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß reverse
    setHistory(recentHistory);
  };

  useEffect(() => {
    fetchHistory();  // ‡∏î‡∏∂‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Component ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î
  }, []);

  const handleAuth = async (action) => {
    const params = new URLSearchParams({ action, username, password });
    const res = await fetch(BACKEND_URL, { method: 'POST', body: params });
    const result = await res.json();

    if (result.status === 'LoginSuccess') {
      setIsLoggedIn(true);
      setToken(result.token || 0);
      setView(result.role === 'admin' ? 'admin' : 'dashboard');
    } else if (result.status === 'Registered') {
      alert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
      setView('login');
    } else if (result.status === 'UsernameAlreadyExists') {
      alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
    } else if (result.status === 'InvalidCredentials') {
      alert('‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
    } else {
      alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + result.status);
    }
  };

  const handleDraw = async () => {
    if (token <= 0) return alert('‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ Token ‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°!');
    if (!characterName) return alert('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏∏‡πà‡∏°!');
    if (isRolling) return;

    setIsRolling(true);
    setItem(null);

    const url = `${BACKEND_URL}?username=${username}&character=${characterName}`;
    const res = await fetch(url);
    const data = await res.json();

    if (data === 'NotEnoughTokens') {
      alert('Token ‡πÑ‡∏°‡πà‡∏û‡∏≠!');
      setIsRolling(false);
    } else {
      setTimeout(() => {
        setItem(data);
        setToken((prev) => prev - 1);
        setHistory((prevHistory) => [...prevHistory, { ...data, time: new Date().toLocaleString() }]); // Add to history with time
        setIsRolling(false);
      }, 5000);
    }
  };

  const handleAdminAddToken = async () => {
    const params = new URLSearchParams({
      action: 'addtoken',
      username: adminUser,
      token: adminTokens,
    });
    const res = await fetch(BACKEND_URL, { method: 'POST', body: params });
    const result = await res.json();
    alert(result.status === 'TokenAdded' ? '‡πÄ‡∏ï‡∏¥‡∏° Token ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ');
  };

  return (
    <div className="app-container">
      {view === 'login' && (
        <div className="auth-container">
          <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
          <input className="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" value={username} onChange={(e) => setUsername(e.target.value)} />
          <input className="input-field" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
          <button className="btn" onClick={() => handleAuth('login')}>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
          <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ? <span className="link" onClick={() => setView('register')}>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span></p>
        </div>
      )}

      {view === 'register' && (
        <div className="auth-container">
          <h2>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
          <input className="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ" value={username} onChange={(e) => setUsername(e.target.value)} />
          <input className="input-field" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
          <button className="btn" onClick={() => handleAuth('register')}>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
          <p>‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß? <span className="link" onClick={() => setView('login')}>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span></p>
        </div>
      )}

      {view === 'dashboard' && (
        <div className="container">
          <div className="dashboard-container">
            <h2>üéÆ N-age Warzone Gacha!!</h2>
            <div className="token-display">Token ‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: {token}</div>
            <input className="input-field" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" value={characterName} onChange={(e) => setCharacterName(e.target.value)} />
            <button className="btn btn-gacha" onClick={handleDraw} disabled={isRolling}>
              {isRolling ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°...' : '‡∏™‡∏∏‡πà‡∏°‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏° üîÆ'}
            </button>

            {isRolling && (
              <div className="rolling-container">
                <div className="rolling-strip">
                  {Array(30).fill(null).map((_, i) => (
                    <div className="rolling-item" key={i}>
                      {ITEM_LIST[Math.floor(Math.random() * ITEM_LIST.length)]}
                    </div>
                  ))}
                </div>
              </div>
            )}

            {item && !isRolling && (
              <div className="item-display-card">
                <div className="item-name">üéÅ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö: {item.item}</div>
                <div className="character-name">‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£: {item.character}</div>
              </div>
            )}
            
            <button className="btn btn-logout" onClick={() => { setIsLoggedIn(false); setView('login'); }}>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
          </div>

          {/* Left - History */}
          <div className="history-container">
            <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</h3>
            <table className="history-table">
              <thead>
                <tr>
                  <th>‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</th>
                  <th>‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</th>
                  <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                </tr>
              </thead>
              <tbody>
                {history.map((entry, index) => (
                  <tr key={index}>
                    <td>{entry.character}</td>
                    <td>{entry.item}</td> {/* ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö */}
                    <td>{entry.time}</td> {/* ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏ß‡∏•‡∏≤ */}
                  </tr>
                ))}
              </tbody>
            </table>
          </div>

          {/* Right - Rate */}
          <div className="rate-container">
            <h3>‡πÄ‡∏£‡∏ó‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</h3>
            <table className="rate-table">
              <thead>
                <tr>
                  <th>‡πÑ‡∏≠‡πÄ‡∏ó‡πá‡∏°</th>
                  <th>‡πÄ‡∏£‡∏ó</th>
                </tr>
              </thead>
              <tbody>
                {rate.map((entry, index) => (
                  <tr key={index}>
                    <td>{entry.item}</td>
                    <td>{entry.rate}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  );
}
